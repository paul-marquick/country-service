@using CountryService.BlazorAdminApp.HttpClients
@using CountryService.Dtos.Log
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop
@inherits ErrorBoundary
@inject ILogger<CustomErrorBoundary> Logger
@inject ILogHttpClient logHttpClient
@inject IWebAssemblyHostEnvironment webAssemblyHostEnvironment
@inject IJSRuntime jsRuntime

@if (CurrentException is null)
{
    @ChildContent
}
else if (ErrorContent is not null)
{
    @ErrorContent(CurrentException)
}

@code {

    // Sends error details to the server. 
    protected override async Task OnErrorAsync(Exception ex)
    {        
        Logger.LogError("An error has occurred. The Administrator has been notified.");

        string details = "BaseAddress: " + webAssemblyHostEnvironment.BaseAddress + 
            ", Environment: " + webAssemblyHostEnvironment.Environment +
            ", IsProduction: " + webAssemblyHostEnvironment.IsProduction() + 
            ", IsDevelopment: " + webAssemblyHostEnvironment.IsDevelopment() + 
            ", IsStaging: " + webAssemblyHostEnvironment.IsStaging() + 
            ", ClientProperties: " + await getClientPropertiesAsync() + 
            ". ";

        if (webAssemblyHostEnvironment.IsDevelopment())
        {
            Logger.LogError(details + ex.Message);
        }

        await logHttpClient.PostLogAsync(
            new Log 
            { 
                Message = "Blazor admin app error. " + details + ex.Message 
            }
        );
    }

    // Gets some client properties from JavaScript. 
    private async Task<string> getClientPropertiesAsync() 
    {
        return await jsRuntime.InvokeAsync<string>("getClientProperties");
    }
}
